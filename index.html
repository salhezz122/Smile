<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title></title>
  <style>
    /* =========================
       THEME / RESET
    ========================== */
    :root{
      --bg:#0b1020;
      --bg2:#0e1630;
      --card:#101b3d;
      --card2:#0e1736;
      --text:#eaf0ff;
      --muted:#b9c5ff;
      --muted2:#92a2e6;
      --line:rgba(255,255,255,.10);
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:12px;

      --brand:#7c5cff;
      --brand2:#4fd1c5;
      --danger:#ff4d6d;
      --warn:#ffbf36;
      --ok:#45d483;
      --info:#4cb3ff;

      --focus: 0 0 0 3px rgba(124,92,255,.35);
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 90% -10%, rgba(124,92,255,.28), transparent 60%),
        radial-gradient(900px 600px at -10% 20%, rgba(79,209,197,.18), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
    }
    a{color:inherit}
    button, input, select, textarea{
      font:inherit;
      color:inherit;
      background:transparent;
      border:1px solid var(--line);
      outline:none;
    }
    input,select,textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      background:rgba(255,255,255,.03);
      transition:.15s;
    }
    input:focus,select:focus,textarea:focus{box-shadow:var(--focus); border-color:rgba(124,92,255,.55)}
    textarea{min-height:90px; resize:vertical}
    button{
      cursor:pointer;
      padding:10px 12px;
      border-radius:12px;
      transition:.15s;
      background:rgba(255,255,255,.04);
    }
    button:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.20)}
    button:active{transform:translateY(0px)}
    .btn{
      display:inline-flex; align-items:center; gap:8px; justify-content:center;
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:12px;
      background:rgba(255,255,255,.04);
      user-select:none;
      text-decoration:none;
      white-space:nowrap;
    }
    .btn.primary{
      background:linear-gradient(135deg, rgba(124,92,255,.95), rgba(79,209,197,.55));
      border-color:rgba(124,92,255,.55);
      box-shadow:0 10px 25px rgba(124,92,255,.25);
    }
    .btn.danger{background:rgba(255,77,109,.10); border-color:rgba(255,77,109,.35)}
    .btn.warn{background:rgba(255,191,54,.10); border-color:rgba(255,191,54,.35)}
    .btn.ok{background:rgba(69,212,131,.10); border-color:rgba(69,212,131,.35)}
    .btn.ghost{background:transparent}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      font-size:12px;
      color:var(--muted);
    }
    .pill.ok{border-color:rgba(69,212,131,.35); color:#bff7d6; background:rgba(69,212,131,.10)}
    .pill.warn{border-color:rgba(255,191,54,.35); color:#ffe6a6; background:rgba(255,191,54,.10)}
    .pill.danger{border-color:rgba(255,77,109,.35); color:#ffd0da; background:rgba(255,77,109,.10)}
    .pill.info{border-color:rgba(76,179,255,.35); color:#cfeaff; background:rgba(76,179,255,.10)}
    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}
    .hr{height:1px; background:var(--line); margin:12px 0}
    .hidden{display:none !important}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    /* =========================
       LAYOUT
    ========================== */
    .app{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:16px;
      padding:16px;
      max-width: 1300px;
      margin:0 auto;
    }
    @media (max-width: 820px){
      .app{
        grid-template-columns: 1fr;
        padding:10px;
      }
    }
    /* Force good look on 350px */
    @media (max-width: 380px){
      .app{padding:8px; gap:10px}
      .card{border-radius:14px}
      input,select,textarea,button,.btn{border-radius:12px}
    }

    .card{
      background:linear-gradient(180deg, rgba(16,27,61,.92), rgba(14,23,54,.88));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding:14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.07);
      background:rgba(255,255,255,.02);
    }
    .card .body{padding:14px}
    .title{
      display:flex; flex-direction:column; gap:4px;
    }
    .title b{font-size:15px}
    .title span{font-size:12px; color:var(--muted)}
    .stack{display:flex; flex-direction:column; gap:10px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1 1 180px}
    .row.tight > *{flex:1 1 140px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .topbar .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:38px; height:38px; border-radius:14px;
      background:linear-gradient(135deg, rgba(124,92,255,.95), rgba(79,209,197,.65));
      box-shadow:0 10px 25px rgba(124,92,255,.25);
      display:grid; place-items:center;
      font-weight:900;
    }
    .brand h1{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
    }
    .brand p{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .nav{
      display:flex; flex-direction:column; gap:8px;
      padding:12px;
    }
    .nav button{
      text-align:right;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:12px;
      border-radius:14px;
      background:rgba(255,255,255,.03);
    }
    .nav button.active{
      background:linear-gradient(135deg, rgba(124,92,255,.18), rgba(79,209,197,.10));
      border-color:rgba(124,92,255,.35);
      box-shadow: 0 10px 25px rgba(124,92,255,.10);
    }
    .nav small{color:var(--muted); font-size:12px}
    .nav .badge{
      font-size:12px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background:rgba(255,255,255,.03);
      min-width: 34px;
      text-align:center;
    }

    /* =========================
       TABLE / LIST
    ========================== */
    .list{
      display:flex; flex-direction:column; gap:8px;
    }
    .item{
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.02);
      border-radius:14px;
      padding:12px;
      display:flex; justify-content:space-between; gap:10px;
    }
    .item:hover{border-color:rgba(255,255,255,.15)}
    .item .meta{
      display:flex; flex-direction:column; gap:6px;
      min-width: 0;
    }
    .item .meta b{
      font-size:14px;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .item .meta .sub{
      display:flex; gap:8px; flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
    }
    .item .ops{
      display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
      align-items:center;
    }
    .kpi{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width: 980px){
      .kpi{grid-template-columns: repeat(2,1fr)}
    }
    @media (max-width: 420px){
      .kpi{grid-template-columns: 1fr}
    }
    .kpi .box{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    }
    .kpi .box b{font-size:14px}
    .kpi .box .n{font-size:22px; margin-top:6px; font-weight:900}
    .kpi .box .h{font-size:12px; color:var(--muted); margin-top:6px}

    /* =========================
       MODAL
    ========================== */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:12px;
      z-index: 50;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(720px, 100%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(16,27,61,.98), rgba(14,23,54,.96));
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal .mhead{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      background:rgba(255,255,255,.02);
    }
    .modal .mbody{padding:14px}
    .modal .mfoot{
      padding:14px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex; justify-content:flex-start; gap:8px; flex-wrap:wrap;
    }
    .x{
      width:40px; height:40px;
      display:grid; place-items:center;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
    }

    /* =========================
       LOGIN
    ========================== */
    .loginWrap{
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:16px;
    }
    .loginCard{
      width:min(520px, 100%);
      padding:16px;
      border-radius:24px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(16,27,61,.95), rgba(14,23,54,.90));
      box-shadow:0 30px 80px rgba(0,0,0,.55);
    }
    .loginTop{
      display:flex; align-items:center; gap:12px;
      margin-bottom:12px;
    }
    .loginTop .logo{width:44px; height:44px; border-radius:18px}
    .loginTop h2{margin:0; font-size:18px}
    .loginTop p{margin:0; color:var(--muted); font-size:12px}
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.02);
    }

    /* =========================
       PRINT (optional)
    ========================== */
    @media print{
      body{background:#fff; color:#000}
      .card,.modal,.loginCard{box-shadow:none}
      .nav, .actions, .btn, button, .overlay{display:none !important}
      .app{grid-template-columns: 1fr; max-width:100%}
      .card{border:1px solid #ddd; background:#fff}
    }
    body{
  margin:0;
  font-family:var(--font);
  color:var(--text);
 background:
  linear-gradient(rgba(0,0,0,.7), rgba(0,0,0,.7)),
  url("https://images.unsplash.com/photo-1629909613654-28e377c37b09?q=80&w=1600&auto=format&fit=crop")
  no-repeat center center fixed;
background-size: cover;

}
.loginCard{
  width:100%;
  max-width:480px;
  padding:40px;
  border-radius:28px;

  background:transparent;
  backdrop-filter:blur(12px);

  border:2px solid transparent;
  background-clip:padding-box;

  position:relative;
}

.loginCard::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:28px;
  padding:2px;
  background:linear-gradient(135deg,#d4af37,#f7e08a,#d4af37);
  -webkit-mask:
     linear-gradient(#000 0 0) content-box,
     linear-gradient(#000 0 0);
  -webkit-mask-composite: xor;
  mask-composite: exclude;
}
.loginTop .logo{
  width:55px;
  height:55px;
  border-radius:18px;

  background:linear-gradient(135deg,#d4af37,#f7e08a);
  color:#111;

  font-weight:900;
  font-size:20px;

  display:flex;
  align-items:center;
  justify-content:center;

  box-shadow:0 0 25px rgba(212,175,55,.45);
}
.loginTop h2{
  background:linear-gradient(90deg,#d4af37,#f7e08a,#d4af37);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.btn.primary{
  background:linear-gradient(135deg,#d4af37,#f7e08a);
  border:none;
  color:#111;
  font-weight:700;
  letter-spacing:.5px;
}

.btn.primary:hover{
  transform:translateY(-3px);
  box-shadow:0 15px 35px rgba(212,175,55,.5);
}
#passInput{
  border:2px solid #d4af37;
  background:transparent;
  color:#fff;
  border-radius:14px;
  padding:14px;
  transition:.3s;
}
.loginCard::before{
  pointer-events: none;
}

  </style>
</head>
<body>

<!-- =========================
     LOGIN VIEW
========================== -->
<div id="loginView" class="loginWrap hidden">
  <div class="loginCard">
    <div class="loginTop">
      <div class="logo">R</div>
      <div>
        <h2>Royal Smile Clinic</h2>
        <p> ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…) Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù…ÙˆØ¬ÙˆØ¯ ÙÙ‚Ø· Ø¹Ù†Ø¯ ØµØ§Ø­Ø¨ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ÙˆÙ…Ù† Ù…Ø³Ø¤Ù„ Ø¹Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„</p>
      </div>
    </div>

    <div class="stack">
      <div class="hint">
        <b>Ø³ÙŠØ³ØªÙ… Ø°ÙƒÙŠ Ù„Ø£Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª </b>
       
        <div class="hr"></div>
        ğŸ“… Ø­Ø¬Ø² ÙˆØ¥Ø¯Ø§Ø±Ø© Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø±Ø¶Ù‰
ğŸ‘¥ Ø£Ø±Ø´ÙŠÙ ÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø±Ø¶Ù‰ (ØªØ§Ø±ÙŠØ®ØŒ Ø¬Ù„Ø³Ø§ØªØŒ Ù…Ù„Ø§Ø­Ø¸Ø§Øª)
ğŸ”¢ Ù…ØªØ§Ø¨Ø¹Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ù„ÙƒÙ„ Ù…Ø±ÙŠØ¶
ğŸ’° ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
      </div>

      <div>
        <label class="muted">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <br><br>
        <input id="passInput" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
      </div>
      <br>
      <div class="row tight">
        <button class="btn primary" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn warn" id="resetPassBtn" title="ÙŠÙ…Ø³Ø­ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (ÙŠØ­ØªØ§Ø¬ ØªØ£ÙƒÙŠØ¯)">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
      </div>

      <div id="loginMsg" class="hint hidden"></div>
    </div>
  </div>
</div>

<!-- =========================
     APP VIEW
========================== -->
<div id="appView" class="app hidden">

  <!-- SIDEBAR -->
  <div class="card">
    <div class="head">
      <div class="title">
        <b>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</b>
        <span id="subStatus">Ø¬Ø§Ù‡Ø²</span>
      </div>
      <div class="pill info" id="todayPill">Ø§Ù„ÙŠÙˆÙ…</div>
    </div>
    <div class="nav">
      <button data-tab="dashboard" class="active">
        <span>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
        <span class="badge" id="badgeDash">â€”</span>
      </button>
      <button data-tab="patients">
        <span>ğŸ§¾ Ø§Ù„Ù…Ø±Ø¶Ù‰</span>
        <span class="badge" id="badgePatients">0</span>
      </button>
      <button data-tab="appointments">
        <span>ğŸ“… Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</span>
        <span class="badge" id="badgeAppts">0</span>
      </button>
      <button data-tab="accounts">
        <span>ğŸ’³ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</span>
        <span class="badge" id="badgePayments">0</span>
      </button>
      <button data-tab="settings">
        <span>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª / Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</span>
        <span class="badge">â†¯</span>
      </button>

      <div class="hr"></div>

      <button id="logoutBtn">
        <span>ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span>
        <span class="badge">â»</span>
      </button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="stack">

    <div class="topbar">
      <div class="brand">
        <div style="background-color:gold ;" class="logo"><h1>R</h1></div>
        <div>
          <h1 id="pageTitle">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
          <p id="pageSub" class="muted">Ù…Ù„Ø®Øµ Ø´Ø§Ù…Ù„ + Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</p>
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" id="quickAddPatient">+ Ù…Ø±ÙŠØ¶</button>
        <button class="btn" id="quickAddAppt">+ Ù…ÙˆØ¹Ø¯</button>
        <button class="btn" id="quickAddPayment">+ Ø¯ÙØ¹Ø©</button>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="tab-dashboard" class="card">
      <div class="head">
        <div class="title">
          <b>Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…</b>
          <span>Ù†Ø¸Ø±Ø© Ø³Ø±ÙŠØ¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</span>
        </div>
        <div class="row tight" style="max-width:320px">
          <button class="btn ghost" id="seedBtn" title="ÙŠØ¶ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)">âš¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
        </div>
      </div>
      <div class="body">
        <div class="kpi">
          <div class="box">
            <b>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰</b>
            <div class="n" id="kpiPatients">0</div>
            <div class="h">Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„ÙƒØ§Ù…Ù„</div>
          </div>
          <div class="box">
            <b>Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…</b>
            <div class="n" id="kpiTodayAppts">0</div>
            <div class="h">Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø·</div>
          </div>
          <div class="box">
            <b>Ø¯ÙØ¹Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</b>
            <div class="n" id="kpiMonthPayments">0</div>
            <div class="h">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª</div>
          </div>
          <div class="box">
            <b>Ø±ØµÙŠØ¯ Ù…Ø³ØªØ­Ù‚</b>
            <div class="n" id="kpiDue">0</div>
            <div class="h">Ø­Ø³Ø¨ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div class="card" style="box-shadow:none; border-radius:16px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.02)">
            <div class="head">
              <div class="title">
                <b>Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù‚Ø§Ø¯Ù…Ø©</b>
                <span>Ø£Ù‚Ø±Ø¨ 7 Ø£ÙŠØ§Ù…</span>
              </div>
              <div class="pill info" id="nextCountPill">0</div>
            </div>
            <div class="body">
              <div id="dashUpcoming" class="list"></div>
              <div id="dashUpcomingEmpty" class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù‚Ø§Ø¯Ù…Ø©â€¦</div>
            </div>
          </div>

          <div class="card" style="box-shadow:none; border-radius:16px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.02)">
            <div class="head">
              <div class="title">
                <b>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</b>
                <span>Ø£Ø´ÙŠØ§Ø¡ ØªØ­ØªØ§Ø¬ Ø§Ù†ØªØ¨Ø§Ù‡</span>
              </div>
              <div class="pill warn">Ù…Ù‡Ù…</div>
            </div>
            <div class="body">
              <div id="dashAlerts" class="list"></div>
              <div id="dashAlertsEmpty" class="hint">ÙƒÙ„ Ø´ÙŠØ¡ ØªÙ…Ø§Ù… ğŸ‰</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PATIENTS -->
    <div id="tab-patients" class="card hidden">
      <div class="head">
        <div class="title">
          <b>Ø§Ù„Ù…Ø±Ø¶Ù‰</b>
          <span>Ø¥Ø¶Ø§ÙØ©/Ø¨Ø­Ø«/Ù…ØªØ§Ø¨Ø¹Ø©/Ø¬Ù„Ø³Ø§Øª</span>
        </div>
        <div class="row tight" style="max-width:520px">
          <input id="patientSearch" placeholder="Ø§Ø¨Ø­Ø«: Ø§Ø³Ù… / Ù‡Ø§ØªÙ / Ø±Ù‚Ù… Ù…Ù„Ùâ€¦" />
          <button class="btn primary" id="addPatientBtn">+ Ø¥Ø¶Ø§ÙØ©</button>
        </div>
      </div>
      <div class="body">
        <div id="patientsList" class="list"></div>
        <div id="patientsEmpty" class="hint">Ù…Ø§ ÙÙŠ Ù…Ø±Ø¶Ù‰ Ø¨Ø¹Ø¯. Ø§Ø¶ØºØ· â€œØ¥Ø¶Ø§ÙØ©â€.</div>
      </div>
    </div>

    <!-- APPOINTMENTS -->
    <div id="tab-appointments" class="card hidden">
      <div class="head">
        <div class="title">
          <b>Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</b>
          <span>Ø­Ø¬Ø² ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ + ÙÙ„ØªØ±Ø©</span>
        </div>
        <div class="row" style="max-width:720px">
          <input id="apptSearch" placeholder="Ø§Ø¨Ø­Ø«: Ø§Ø³Ù… Ù…Ø±ÙŠØ¶ / Ù…Ù„Ø§Ø­Ø¸Ø© / Ø­Ø§Ù„Ø©â€¦" />
          <input id="apptFrom" type="date" />
          <input id="apptTo" type="date" />
          <button class="btn primary" id="addApptBtn">+ Ù…ÙˆØ¹Ø¯</button>
        </div>
      </div>
      <div class="body">
        <div class="row tight">
          <select id="apptStatusFilter">
            <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
            <option value="scheduled">Ù…Ø¬Ø¯ÙˆÙ„</option>
            <option value="done">ØªÙ…</option>
            <option value="cancelled">Ù…Ù„ØºÙ‰</option>
          </select>
          <button class="btn" id="clearApptFilters">Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
        </div>
        <div class="hr"></div>
        <div id="apptsList" class="list"></div>
        <div id="apptsEmpty" class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø¶Ù…Ù† Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</div>
      </div>
    </div>

    <!-- ACCOUNTS -->
    <div id="tab-accounts" class="card hidden">
      <div class="head">
        <div class="title">
          <b>Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</b>
          <span>Ø¯ÙØ¹Ø§Øª + Ø£Ø±ØµØ¯Ø© + ÙƒØ´Ù Ø­Ø³Ø§Ø¨</span>
        </div>
        <div class="row tight" style="max-width:560px">
          <input id="paySearch" placeholder="Ø§Ø¨Ø­Ø«: Ø§Ø³Ù… Ù…Ø±ÙŠØ¶ / Ø·Ø±ÙŠÙ‚Ø© Ø¯ÙØ¹ / Ù…Ù„Ø§Ø­Ø¸Ø©â€¦" />
          <button class="btn primary" id="addPaymentBtn">+ Ø¯ÙØ¹Ø©</button>
        </div>
      </div>
      <div class="body">
        <div id="paymentsList" class="list"></div>
        <div id="paymentsEmpty" class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ø¨Ø¹Ø¯.</div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div id="tab-settings" class="card hidden">
      <div class="head">
        <div class="title">
          <b>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª / Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ</b>
          <span>ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯/Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
        </div>
        <div class="pill info">Settings</div>
      </div>
      <div class="body">
        <div class="row">
          <div class="stack">
            <div class="hint">
              <b>Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ:</b> ØµØ¯Ù‘Ø± Ù…Ù„Ù JSON ÙˆØ§Ø­ØªÙØ¸ ÙÙŠÙ‡ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¬Ù‡Ø§Ø².
              <div class="hr"></div>
              <span class="muted2">Ø§Ø³ØªÙŠØ±Ø§Ø¯</span> Ø³ÙŠØ³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
            </div>
            <div class="row tight">
              <button class="btn ok" id="exportBtn">â¬‡ï¸ ØªØµØ¯ÙŠØ± JSON</button>
              <button class="btn warn" id="importBtn">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
              <input id="importFile" type="file" accept="application/json" class="hidden"/>
            </div>

            <div class="hr"></div>

            <div class="hint">
              <b>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</b> ÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§ Ù…Ø´ÙØ±Ø© (SHA-256).
              <div class="hr"></div>
              <span class="muted2">Ù…Ù„Ø§Ø­Ø¸Ø©:</span> Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ.
            </div>
            <div class="row tight">
              <input id="newPass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©" />
              <button class="btn primary" id="changePassBtn">ØªØºÙŠÙŠØ±</button>
            </div>

            <div class="hr"></div>

            <div class="hint">
              <b class="mono">Ø­Ø§Ù„Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†</b>
              <div class="hr"></div>
              <div id="storageInfo" class="mono muted" style="font-size:12px">â€”</div>
            </div>
          </div>

          <div class="stack">
            <div class="hint">
              <b>Ø¹Ù…Ù„ÙŠØ§Øª Ø®Ø·ÙŠØ±Ø©:</b> Ø§Ø³ØªØ®Ø¯Ù… Ø¨Ø­Ø°Ø±.
              <div class="hr"></div>
              <span class="muted2">Ù…Ù…ÙƒÙ† ØªØ¹Ù…Ù„ Reset ÙƒØ§Ù…Ù„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</span>
            </div>
            <button class="btn danger" id="wipeDataBtn">ğŸ§¨ Ù…Ø³Ø­ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</button>
            <button class="btn danger" id="wipeAllBtn" title="ÙŠÙ…Ø³Ø­ ÙƒÙ„ Ø´ÙŠØ¡ Ø­ØªÙ‰ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">ğŸ”¥ Ù…Ø³Ø­ Ø´Ø§Ù…Ù„ (Ø­ØªÙ‰ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±)</button>

            <div class="hr"></div>

            <div class="hint">
              <b>Ø·Ø¨Ø§Ø¹Ø©:</b> ÙŠÙ…ÙƒÙ†Ùƒ Ø·Ø¨Ø§Ø¹Ø© Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø±ÙŠØ¶ (ÙƒØ´Ù Ø­Ø³Ø§Ø¨/Ù…ØªØ§Ø¨Ø¹Ø©) Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­.
              <div class="hr"></div>
              Ù…Ù† Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„: Ù…Ø´Ø§Ø±ÙƒØ© > Ø·Ø¨Ø§Ø¹Ø© (Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù‡Ø§Ø²).
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- =========================
     MODAL (Reusable)
========================== -->
<div id="overlay" class="overlay">
  <div class="modal">
    <div class="mhead">
      <div class="title">
        <b id="modalTitle">â€”</b>
        <span id="modalSub" class="muted">â€”</span>
      </div>
      <button class="x" id="modalClose" title="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
    </div>
    <div class="mbody" id="modalBody"></div>
    <div class="mfoot" id="modalFoot"></div>
  </div>
</div>

<script>
/* ============================================================================
  CLINIC SYSTEM â€” SINGLE FILE (LocalStorage)
  - Patients archive + follow-up
  - Sessions count + quick add session
  - Appointments CRUD + status
  - Payments CRUD + balance
  - Password-only login with SHA-256
============================================================================ */

/* =========================
   UTILITIES
========================= */
const $ = (q, root=document) => root.querySelector(q);
const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
const fmtDate = (d) => {
  const dt = new Date(d);
  if (isNaN(dt)) return "â€”";
  return dt.toLocaleDateString("ar-JO", {year:"numeric", month:"2-digit", day:"2-digit"});
};
const fmtTime = (d) => {
  const dt = new Date(d);
  if (isNaN(dt)) return "â€”";
  return dt.toLocaleTimeString("ar-JO", {hour:"2-digit", minute:"2-digit"});
};
const fmtMoney = (n) => {
  const x = Number(n||0);
  return x.toLocaleString("ar-JO") + " Ø¯.Ø£";
};
const uid = () => (crypto.randomUUID ? crypto.randomUUID() : ("id_"+Math.random().toString(16).slice(2)+Date.now()));
const clamp = (s, n=80) => (String(s||"").length>n ? String(s).slice(0,n-1)+"â€¦" : String(s||""));
const todayISO = () => new Date().toISOString().slice(0,10);
const monthKey = () => new Date().toISOString().slice(0,7); // YYYY-MM
function escapeHtml(str){
  return String(str??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* =========================
   STORAGE
========================= */
const KEY = "CLINIC_SYS_V1";
const PASS_KEY = "CLINIC_SYS_PASS_HASH_V1";
const SESSION_KEY = "CLINIC_SYS_SESSION_V1";

function loadDB(){
  const raw = localStorage.getItem(KEY);
  if(!raw){
    const init = {
      meta:{ createdAt: new Date().toISOString(), version:"1.0.0", clinicName:"Ø¹ÙŠØ§Ø¯ØªÙŠ" },
      patients:[],
      appointments:[],
      payments:[]
    };
    localStorage.setItem(KEY, JSON.stringify(init));
    return init;
  }
  try{ return JSON.parse(raw); }
  catch(e){
    // fallback if corrupted
    const init = { meta:{ createdAt:new Date().toISOString(), version:"1.0.0", clinicName:"Ø¹ÙŠØ§Ø¯ØªÙŠ", corrupted:true }, patients:[], appointments:[], payments:[] };
    localStorage.setItem(KEY, JSON.stringify(init));
    return init;
  }
}
function saveDB(db){ localStorage.setItem(KEY, JSON.stringify(db)); }
function hasPass(){ return !!localStorage.getItem(PASS_KEY); }

function setSession(ok){
  localStorage.setItem(SESSION_KEY, ok ? "1":"0");
}
function isLoggedIn(){
  return localStorage.getItem(SESSION_KEY)==="1";
}

/* =========================
   CRYPTO: SHA-256
========================= */
async function sha256(text){
  const enc = new TextEncoder().encode(text);
  const hashBuf = await crypto.subtle.digest("SHA-256", enc);
  const arr = Array.from(new Uint8Array(hashBuf));
  return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
}

/* =========================
   STATE
========================= */
let db = loadDB();
let currentTab = "dashboard";
let selectedPatientId = null;

function rebuildBadges(){
  $("#badgePatients").textContent = db.patients.length;
  $("#badgeAppts").textContent = db.appointments.length;
  $("#badgePayments").textContent = db.payments.length;
  $("#badgeDash").textContent = "âœ“";
}

function setStatus(text){
  $("#subStatus").textContent = text;
}

function setTodayPill(){
  const now = new Date();
  const label = now.toLocaleDateString("ar-JO", {weekday:"long", year:"numeric", month:"long", day:"numeric"});
  $("#todayPill").textContent = label;
}

/* =========================
   NAV / TAB
========================= */
function switchTab(tab){
  currentTab = tab;
  $$(".nav button[data-tab]").forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
  $$("#appView [id^='tab-']").forEach(el=>el.classList.add("hidden"));
  $("#tab-"+tab).classList.remove("hidden");

  const titles = {
    dashboard:["Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…","Ù…Ù„Ø®Øµ Ø´Ø§Ù…Ù„ + Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©"],
    patients:["Ø§Ù„Ù…Ø±Ø¶Ù‰","Ø¥Ø¶Ø§ÙØ©/Ø¨Ø­Ø«/Ù…ØªØ§Ø¨Ø¹Ø©/Ø¬Ù„Ø³Ø§Øª"],
    appointments:["Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯","Ø­Ø¬Ø² ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ + ÙÙ„ØªØ±Ø©"],
    accounts:["Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª","Ø¯ÙØ¹Ø§Øª + Ø£Ø±ØµØ¯Ø© + ÙƒØ´Ù Ø­Ø³Ø§Ø¨"],
    settings:["Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª / Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ","ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯/Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"]
  };
  $("#pageTitle").textContent = titles[tab]?.[0] || "â€”";
  $("#pageSub").textContent = titles[tab]?.[1] || "â€”";

  renderAll();
}

$$(".nav button[data-tab]").forEach(btn=>{
  btn.addEventListener("click", ()=> switchTab(btn.dataset.tab));
});

/* =========================
   MODAL
========================= */
function openModal({title, sub, bodyHTML, footHTML, onOpen}){
  $("#modalTitle").textContent = title || "â€”";
  $("#modalSub").textContent = sub || "";
  $("#modalBody").innerHTML = bodyHTML || "";
  $("#modalFoot").innerHTML = footHTML || "";
  $("#overlay").classList.add("show");
  if (typeof onOpen==="function") onOpen();
}
function closeModal(){
  $("#overlay").classList.remove("show");
  $("#modalBody").innerHTML = "";
  $("#modalFoot").innerHTML = "";
}
$("#modalClose").addEventListener("click", closeModal);
$("#overlay").addEventListener("click", (e)=>{
  if(e.target.id==="overlay") closeModal();
});
document.addEventListener("keydown", (e)=>{
  if(e.key==="Escape") closeModal();
});

/* =========================
   DOMAIN: PATIENTS
========================= */
function patientById(id){ return db.patients.find(p=>p.id===id) || null; }
function patientName(id){ return patientById(id)?.name || "â€”"; }

function calcPatientStats(pid){
  const p = patientById(pid);
  if(!p) return {sessions:0, pricePerSession:0, billed:0, paid:0, due:0};

  const sessions = Number(p.sessionsCount||0);
  const price = Number(p.pricePerSession||0);
  const billed = sessions * price;

  const paid = db.payments
    .filter(x=>x.patientId===pid)
    .reduce((a,b)=>a+Number(b.amount||0), 0);

  const due = billed - paid;
  return {sessions, pricePerSession:price, billed, paid, due};
}

function upsertPatient(patient){
  const i = db.patients.findIndex(x=>x.id===patient.id);
  if(i>=0) db.patients[i] = patient;
  else db.patients.unshift(patient);
  saveDB(db);
}

function deletePatient(pid){
  // Also remove related appointments/payments? We'll keep them but mark patient missing? Better: remove related too (clean).
  db.patients = db.patients.filter(p=>p.id!==pid);
  db.appointments = db.appointments.filter(a=>a.patientId!==pid);
  db.payments = db.payments.filter(p=>p.patientId!==pid);
  saveDB(db);
}

function addFollowUp(pid, note){
  const p = patientById(pid);
  if(!p) return;
  p.followUps = Array.isArray(p.followUps) ? p.followUps : [];
  p.followUps.unshift({ id: uid(), at: new Date().toISOString(), note: String(note||"").trim() });
  upsertPatient(p);
}

function incSession(pid, note){
  const p = patientById(pid);
  if(!p) return;
  p.sessionsCount = Number(p.sessionsCount||0) + 1;
  p.followUps = Array.isArray(p.followUps) ? p.followUps : [];
  p.followUps.unshift({ id: uid(), at: new Date().toISOString(), note: note ? ("Ø¬Ù„Ø³Ø©: " + String(note)) : "Ø¬Ù„Ø³Ø© Ù…Ø³Ø¬Ù„Ø©" });
  upsertPatient(p);
}

function patientCardHTML(p){
  const st = calcPatientStats(p.id);
  const phone = p.phone ? `ğŸ“ ${escapeHtml(p.phone)}` : "ğŸ“ â€”";
  const fileNo = p.fileNo ? `ğŸ—‚ï¸ ${escapeHtml(p.fileNo)}` : "ğŸ—‚ï¸ â€”";
  const sess = `ğŸ§  Ø¬Ù„Ø³Ø§Øª: ${st.sessions}`;
  const duePill = st.due>0 ? `<span class="pill warn">Ù…Ø³ØªØ­Ù‚ ${fmtMoney(st.due)}</span>` : (st.due<0 ? `<span class="pill info">Ø±ØµÙŠØ¯ ${fmtMoney(Math.abs(st.due))}</span>` : `<span class="pill ok">Ù…ØµÙÙ‘Ù‰</span>`);
  return `
    <div class="item">
      <div class="meta">
        <b title="${escapeHtml(p.name)}">${escapeHtml(p.name)}</b>
        <div class="sub">
          <span>${fileNo}</span>
          <span>${phone}</span>
          <span>${sess}</span>
        </div>
        <div class="sub">
          <span class="muted2">Ø§Ù„Ø³Ø¹Ø±/Ø¬Ù„Ø³Ø©: ${fmtMoney(p.pricePerSession||0)}</span>
          <span>${duePill}</span>
        </div>
      </div>
      <div class="ops">
        <button class="btn" data-act="view" data-id="${p.id}">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
        <button class="btn ok" data-act="session" data-id="${p.id}">+ Ø¬Ù„Ø³Ø©</button>
        <button class="btn" data-act="edit" data-id="${p.id}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn danger" data-act="del" data-id="${p.id}">ğŸ—‘ï¸</button>
      </div>
    </div>
  `;
}

function renderPatients(){
  const q = ($("#patientSearch").value||"").trim().toLowerCase();
  const list = db.patients
    .filter(p=>{
      if(!q) return true;
      const hay = [p.name,p.phone,p.fileNo,p.notes].join(" ").toLowerCase();
      return hay.includes(q);
    });

  $("#patientsList").innerHTML = list.map(patientCardHTML).join("");
  $("#patientsEmpty").classList.toggle("hidden", list.length>0);

  // bind ops
  $$("#patientsList [data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.id;
      const act = btn.dataset.act;
      if(act==="view") openPatientProfile(id);
      if(act==="edit") openPatientForm(patientById(id));
      if(act==="session") openQuickSession(id);
      if(act==="del") confirmDanger("Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶ØŸ", "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆÙƒÙ„ Ù…ÙˆØ§Ø¹ÙŠØ¯Ù‡ ÙˆØ¯ÙØ¹Ø§ØªÙ‡.", ()=>{
        deletePatient(id);
        db = loadDB();
        renderAll();
        toast("ØªÙ… Ø§Ù„Ø­Ø°Ù");
      });
    });
  });
}

function openPatientForm(existing=null){
  const isEdit = !!existing;
  const p = existing || {
    id: uid(),
    name:"",
    phone:"",
    fileNo:"",
    gender:"",
    birthYear:"",
    address:"",
    notes:"",
    pricePerSession: 0,
    sessionsCount: 0,
    followUps:[]
  };

  openModal({
    title: isEdit ? "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±ÙŠØ¶" : "Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯",
    sub: "Ø§Ù„Ø£Ø±Ø´ÙŠÙ + Ø§Ù„Ø³Ø¹Ø±/Ø¬Ù„Ø³Ø© + Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©",
    bodyHTML: `
      <div class="stack">
        <div class="row">
          <div>
            <label class="muted">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
            <input id="pf_name" value="${escapeHtml(p.name)}" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯" />
          </div>
          <div>
            <label class="muted">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
            <input id="pf_phone" value="${escapeHtml(p.phone)}" placeholder="07xxxxxxxx" />
          </div>
        </div>

        <div class="row">
          <div>
            <label class="muted">Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù</label>
            <input id="pf_file" value="${escapeHtml(p.fileNo)}" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
          </div>
          <div>
            <label class="muted">Ø§Ù„Ø¬Ù†Ø³</label>
            <select id="pf_gender">
              <option value="" ${p.gender===""?"selected":""}>â€”</option>
              <option value="male" ${p.gender==="male"?"selected":""}>Ø°ÙƒØ±</option>
              <option value="female" ${p.gender==="female"?"selected":""}>Ø£Ù†Ø«Ù‰</option>
            </select>
          </div>
          <div>
            <label class="muted">Ø³Ù†Ø© Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
            <input id="pf_birth" inputmode="numeric" value="${escapeHtml(p.birthYear)}" placeholder="Ù…Ø«Ø§Ù„: 1994" />
          </div>
        </div>

        <div class="row">
          <div>
            <label class="muted">Ø§Ù„Ø³Ø¹Ø± Ù„ÙƒÙ„ Ø¬Ù„Ø³Ø© (Ø¯.Ø£)</label>
            <input id="pf_price" inputmode="decimal" value="${escapeHtml(p.pricePerSession)}" placeholder="Ù…Ø«Ø§Ù„: 20" />
          </div>
          <div>
            <label class="muted">Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
            <input id="pf_sessions" inputmode="numeric" value="${escapeHtml(p.sessionsCount)}" placeholder="0" />
          </div>
        </div>

        <div>
          <label class="muted">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
          <input id="pf_address" value="${escapeHtml(p.address)}" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
        </div>

        <div>
          <label class="muted">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©</label>
          <textarea id="pf_notes" placeholder="ØªØ´Ø®ÙŠØµ/Ø­Ø³Ø§Ø³ÙŠØ©/Ù…Ù„Ø§Ø­Ø¸Ø§Øªâ€¦">${escapeHtml(p.notes)}</textarea>
        </div>

        <div class="hint">
          <b>Ù…Ø¹Ù„ÙˆÙ…Ø©:</b> ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„Ø¬Ù„Ø³Ø§Øª Ù…Ù† ØµÙØ­Ø© â€œØ¹Ø±Ø¶â€ Ù„Ù„Ù…Ø±ÙŠØ¶.
        </div>
      </div>
    `,
    footHTML: `
      <button class="btn primary" id="pf_save">${isEdit?"Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„":"Ø¥Ø¶Ø§ÙØ©"}</button>
      <button class="btn" id="pf_cancel">Ø¥Ù„ØºØ§Ø¡</button>
    `,
    onOpen: ()=>{
      $("#pf_cancel").addEventListener("click", closeModal);
      $("#pf_save").addEventListener("click", ()=>{
        const name = ($("#pf_name").value||"").trim();
        if(!name){
          toast("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨", "warn");
          $("#pf_name").focus();
          return;
        }
        p.name = name;
        p.phone = ($("#pf_phone").value||"").trim();
        p.fileNo = ($("#pf_file").value||"").trim();
        p.gender = $("#pf_gender").value||"";
        p.birthYear = ($("#pf_birth").value||"").trim();
        p.address = ($("#pf_address").value||"").trim();
        p.notes = ($("#pf_notes").value||"").trim();
        p.pricePerSession = Number(($("#pf_price").value||"0").replace(",",".")) || 0;
        p.sessionsCount = Number($("#pf_sessions").value||"0") || 0;
        p.followUps = Array.isArray(p.followUps) ? p.followUps : [];

        upsertPatient(p);
        db = loadDB();
        closeModal();
        renderAll();
        toast(isEdit ? "ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„" : "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©", "ok");
      });
    }
  });
}

function openQuickSession(pid){
  const p = patientById(pid);
  if(!p) return;
  openModal({
    title: `ØªØ³Ø¬ÙŠÙ„ Ø¬Ù„Ø³Ø© â€” ${p.name}`,
    sub: "ÙŠØ²ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª + ÙŠØ¶ÙŠÙ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹",
    bodyHTML: `
      <div class="stack">
        <div class="hint">
          Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <b>${Number(p.sessionsCount||0)}</b>
          <div class="hr"></div>
          Ø§Ù„Ø³Ø¹Ø±/Ø¬Ù„Ø³Ø©: <b>${fmtMoney(p.pricePerSession||0)}</b>
        </div>
        <div>
          <label class="muted">Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea id="qs_note" placeholder="Ù…Ø«Ø§Ù„: Ø¬Ù„Ø³Ø© Ø¹Ù„Ø§Ø¬ Ø·Ø¨ÙŠØ¹ÙŠ / Ù…ØªØ§Ø¨Ø¹Ø©â€¦"></textarea>
        </div>
      </div>
    `,
    footHTML: `
      <button class="btn ok" id="qs_add">+ ØªØ³Ø¬ÙŠÙ„</button>
      <button class="btn" id="qs_cancel">Ø¥Ù„ØºØ§Ø¡</button>
    `,
    onOpen: ()=>{
      $("#qs_cancel").addEventListener("click", closeModal);
      $("#qs_add").addEventListener("click", ()=>{
        const note = ($("#qs_note").value||"").trim();
        incSession(pid, note);
        db = loadDB();
        closeModal();
        renderAll();
        toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø©", "ok");
      });
    }
  });
}

function openPatientProfile(pid){
  const p = patientById(pid);
  if(!p) return;
  selectedPatientId = pid;

  const st = calcPatientStats(pid);

  const follow = (Array.isArray(p.followUps)? p.followUps : []).slice(0, 30).map(f=>{
    return `
      <div class="item">
        <div class="meta">
          <b>${fmtDate(f.at)} â€” ${fmtTime(f.at)}</b>
          <div class="sub"><span>${escapeHtml(f.note || "â€”")}</span></div>
        </div>
        <div class="ops">
          <span class="pill info">${new Date(f.at).toISOString().slice(0,10)}</span>
        </div>
      </div>
    `;
  }).join("");

  const patientAppts = db.appointments
    .filter(a=>a.patientId===pid)
    .sort((a,b)=> new Date(b.at)-new Date(a.at))
    .slice(0, 12)
    .map(a=>{
      const pill = a.status==="done" ? `<span class="pill ok">ØªÙ…</span>` :
                   a.status==="cancelled" ? `<span class="pill danger">Ù…Ù„ØºÙ‰</span>` :
                   `<span class="pill info">Ù…Ø¬Ø¯ÙˆÙ„</span>`;
      return `
        <div class="item">
          <div class="meta">
            <b>${fmtDate(a.at)} â€” ${fmtTime(a.at)}</b>
            <div class="sub">
              <span>${pill}</span>
              <span class="muted2">${escapeHtml(a.note||"")}</span>
            </div>
          </div>
          <div class="ops">
            <button class="btn" data-appt-edit="${a.id}">âœï¸</button>
          </div>
        </div>
      `;
    }).join("");

  const patientPays = db.payments
    .filter(x=>x.patientId===pid)
    .sort((a,b)=> new Date(b.at)-new Date(a.at))
    .slice(0, 12)
    .map(x=>{
      return `
        <div class="item">
          <div class="meta">
            <b>${fmtMoney(x.amount)} â€” ${fmtDate(x.at)}</b>
            <div class="sub">
              <span class="pill info">${escapeHtml(x.method||"â€”")}</span>
              <span class="muted2">${escapeHtml(x.note||"")}</span>
            </div>
          </div>
          <div class="ops">
            <button class="btn" data-pay-edit="${x.id}">âœï¸</button>
          </div>
        </div>
      `;
    }).join("");

  openModal({
    title: `Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙŠØ¶ â€” ${p.name}`,
    sub: `Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù: ${p.fileNo||"â€”"} | Ø§Ù„Ù‡Ø§ØªÙ: ${p.phone||"â€”"}`,
    bodyHTML: `
      <div class="stack">
        <div class="kpi">
          <div class="box">
            <b>Ø§Ù„Ø¬Ù„Ø³Ø§Øª</b>
            <div class="n">${st.sessions}</div>
            <div class="h">Ø³Ø¬Ù„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</div>
          </div>
          <div class="box">
            <b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø­Ø³ÙˆØ¨</b>
            <div class="n">${fmtMoney(st.billed)}</div>
            <div class="h">Ø¬Ù„Ø³Ø§Øª Ã— Ø³Ø¹Ø±</div>
          </div>
          <div class="box">
            <b>Ù…Ø¯ÙÙˆØ¹</b>
            <div class="n">${fmtMoney(st.paid)}</div>
            <div class="h">Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙØ¹Ø§Øª</div>
          </div>
          <div class="box">
            <b>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</b>
            <div class="n">${fmtMoney(st.due)}</div>
            <div class="h">Ù…Ø³ØªØ­Ù‚/Ø±ØµÙŠØ¯</div>
          </div>
        </div>

        <div class="row">
          <div>
            <div class="hint">
              <b>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</b>
              <div class="hr"></div>
              <div class="muted">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</div>
              <div>${escapeHtml(p.address||"â€”")}</div>
              <div class="hr"></div>
              <div class="muted">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©:</div>
              <div>${escapeHtml(p.notes||"â€”")}</div>
            </div>
          </div>

          <div class="stack">
            <div class="row tight">
              <button class="btn ok" id="pp_addSession">+ Ø¬Ù„Ø³Ø©</button>
              <button class="btn primary" id="pp_addFollow">+ Ù…ØªØ§Ø¨Ø¹Ø©</button>
              <button class="btn" id="pp_addAppt">+ Ù…ÙˆØ¹Ø¯</button>
              <button class="btn" id="pp_addPay">+ Ø¯ÙØ¹Ø©</button>
            </div>

            <div class="row tight">
              <button class="btn" id="pp_print">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
              <button class="btn danger" id="pp_delete">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶</button>
            </div>
          </div>
        </div>

        <div class="card" style="box-shadow:none; border-radius:16px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.02)">
          <div class="head">
            <div class="title"><b>Ø³Ø¬Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</b><span>Ø¢Ø®Ø± 30 Ø³Ø¬Ù„</span></div>
            <div class="pill info">${(p.followUps||[]).length}</div>
          </div>
          <div class="body">
            <div class="list">${follow || ""}</div>
            ${follow ? "" : `<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¹Ø¯.</div>`}
          </div>
        </div>

        <div class="row">
          <div class="card" style="box-shadow:none; border-radius:16px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.02)">
            <div class="head">
              <div class="title"><b>Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</b><span>Ø¢Ø®Ø± 12</span></div>
              <div class="pill info">${db.appointments.filter(a=>a.patientId===pid).length}</div>
            </div>
            <div class="body">
              <div class="list">${patientAppts || ""}</div>
              ${patientAppts ? "" : `<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙŠØ¶.</div>`}
            </div>
          </div>

          <div class="card" style="box-shadow:none; border-radius:16px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.02)">
            <div class="head">
              <div class="title"><b>Ø§Ù„Ø¯ÙØ¹Ø§Øª</b><span>Ø¢Ø®Ø± 12</span></div>
              <div class="pill info">${db.payments.filter(x=>x.patientId===pid).length}</div>
            </div>
            <div class="body">
              <div class="list">${patientPays || ""}</div>
              ${patientPays ? "" : `<div class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙŠØ¶.</div>`}
            </div>
          </div>
        </div>
      </div>
    `,
    footHTML: `
      <button class="btn" id="pp_close">Ø¥ØºÙ„Ø§Ù‚</button>
      <button class="btn" id="pp_edit">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª</button>
    `,
    onOpen: ()=>{
      $("#pp_close").addEventListener("click", closeModal);
      $("#pp_edit").addEventListener("click", ()=> { closeModal(); openPatientForm(patientById(pid)); });
      $("#pp_addSession").addEventListener("click", ()=> { closeModal(); openQuickSession(pid); });

      $("#pp_addFollow").addEventListener("click", ()=>{
        const p2 = patientById(pid);
        if(!p2) return;
        openModal({
          title:`Ø¥Ø¶Ø§ÙØ© Ù…ØªØ§Ø¨Ø¹Ø© â€” ${p2.name}`,
          sub:"ØªÙØ¶Ø§Ù ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª Ø§Ù„Ø¢Ù†",
          bodyHTML: `
            <div class="stack">
              <div>
                <label class="muted">Ù†Øµ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© *</label>
                <textarea id="fu_note" placeholder="Ù…Ø«Ø§Ù„: ØªØ­Ø³Ù† Ù…Ù„Ø­ÙˆØ¸â€¦ / ØªØ¹Ø¯ÙŠÙ„ Ø®Ø·Ø©â€¦"></textarea>
              </div>
            </div>
          `,
          footHTML: `
            <button class="btn primary" id="fu_save">Ø­ÙØ¸</button>
            <button class="btn" id="fu_cancel">Ø¥Ù„ØºØ§Ø¡</button>
          `,
          onOpen: ()=>{
            $("#fu_cancel").addEventListener("click", closeModal);
            $("#fu_save").addEventListener("click", ()=>{
              const note = ($("#fu_note").value||"").trim();
              if(!note){ toast("Ø§ÙƒØªØ¨ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©", "warn"); return; }
              addFollowUp(pid, note);
              db = loadDB();
              closeModal();
              openPatientProfile(pid);
              toast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©", "ok");
            });
          }
        });
      });

      $("#pp_addAppt").addEventListener("click", ()=> { closeModal(); openApptForm({patientId: pid}); });
      $("#pp_addPay").addEventListener("click", ()=> { closeModal(); openPaymentForm({patientId: pid}); });

      $("#pp_print").addEventListener("click", ()=> window.print());

      $("#pp_delete").addEventListener("click", ()=>{
        confirmDanger("Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶ØŸ", "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆÙƒÙ„ Ù…ÙˆØ§Ø¹ÙŠØ¯Ù‡ ÙˆØ¯ÙØ¹Ø§ØªÙ‡.", ()=>{
          deletePatient(pid);
          db = loadDB();
          closeModal();
          renderAll();
          toast("ØªÙ… Ø§Ù„Ø­Ø°Ù", "ok");
        });
      });

      // inline edit buttons
      $$("[data-appt-edit]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-appt-edit");
          const ap = db.appointments.find(x=>x.id===id);
          if(ap){ closeModal(); openApptForm(ap); }
        });
      });
      $$("[data-pay-edit]").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = b.getAttribute("data-pay-edit");
          const pay = db.payments.find(x=>x.id===id);
          if(pay){ closeModal(); openPaymentForm(pay); }
        });
      });
    }
  });
}

/* =========================
   DOMAIN: APPOINTMENTS
========================= */
function apptPill(status){
  if(status==="done") return `<span class="pill ok">ØªÙ…</span>`;
  if(status==="cancelled") return `<span class="pill danger">Ù…Ù„ØºÙ‰</span>`;
  return `<span class="pill info">Ù…Ø¬Ø¯ÙˆÙ„</span>`;
}

function openApptForm(existingOrPrefill=null){
  const isEdit = existingOrPrefill && existingOrPrefill.id;
  const ap = isEdit ? {...existingOrPrefill} : {
    id: uid(),
    patientId: existingOrPrefill?.patientId || "",
    at: new Date().toISOString().slice(0,16), // datetime-local
    status: "scheduled",
    note: ""
  };

  const patientOptions = db.patients
    .slice()
    .sort((a,b)=> a.name.localeCompare(b.name, "ar"))
    .map(p=>`<option value="${p.id}" ${p.id===ap.patientId?"selected":""}>${escapeHtml(p.name)} â€” ${escapeHtml(p.phone||"")}</option>`)
    .join("");

  openModal({
    title: isEdit ? "ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¹Ø¯" : "Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯",
    sub: "Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙŠØ¶ + Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª + Ø§Ù„Ø­Ø§Ù„Ø©",
    bodyHTML: `
      <div class="stack">
        <div>
          <label class="muted">Ø§Ù„Ù…Ø±ÙŠØ¶ *</label>
          <select id="af_patient">
            <option value="">â€” Ø§Ø®ØªØ± Ù…Ø±ÙŠØ¶ â€”</option>
            ${patientOptions}
          </select>
        </div>

        <div class="row">
          <div>
            <label class="muted">Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª *</label>
            <input id="af_at" type="datetime-local" value="${escapeHtml(ap.at)}" />
          </div>
          <div>
            <label class="muted">Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="af_status">
              <option value="scheduled" ${ap.status==="scheduled"?"selected":""}>Ù…Ø¬Ø¯ÙˆÙ„</option>
              <option value="done" ${ap.status==="done"?"selected":""}>ØªÙ…</option>
              <option value="cancelled" ${ap.status==="cancelled"?"selected":""}>Ù…Ù„ØºÙ‰</option>
            </select>
          </div>
        </div>

        <div>
          <label class="muted">Ù…Ù„Ø§Ø­Ø¸Ø©</label>
          <textarea id="af_note" placeholder="Ù…Ø«Ø§Ù„: Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¹Ø¯ Ø£Ø³Ø¨ÙˆØ¹â€¦">${escapeHtml(ap.note)}</textarea>
        </div>

        <div class="hint">
          <b>ØªÙ„Ù…ÙŠØ­:</b> Ø¹Ù†Ø¯ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ â€œØªÙ…â€ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ø§Ù‹ ØªØ³Ø¬ÙŠÙ„ Ø¬Ù„Ø³Ø© Ù…Ù† Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙŠØ¶.
        </div>
      </div>
    `,
    footHTML: `
      <button class="btn primary" id="af_save">${isEdit?"Ø­ÙØ¸":"Ø­Ø¬Ø²"}</button>
      ${isEdit? `<button class="btn danger" id="af_del">Ø­Ø°Ù</button>` : ``}
      <button class="btn" id="af_cancel">Ø¥Ù„ØºØ§Ø¡</button>
    `,
    onOpen: ()=>{
      $("#af_cancel").addEventListener("click", closeModal);

      if(isEdit){
        $("#af_del").addEventListener("click", ()=>{
          confirmDanger("Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¹Ø¯ØŸ", "Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.", ()=>{
            db.appointments = db.appointments.filter(x=>x.id!==ap.id);
            saveDB(db);
            db = loadDB();
            closeModal();
            renderAll();
            toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¹Ø¯", "ok");
          });
        });
      }

      $("#af_save").addEventListener("click", ()=>{
        const pid = $("#af_patient").value;
        const at = $("#af_at").value;
        if(!pid){ toast("Ø§Ø®ØªØ± Ù…Ø±ÙŠØ¶", "warn"); return; }
        if(!at){ toast("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ®/ÙˆÙ‚Øª", "warn"); return; }

        ap.patientId = pid;
        ap.at = at;
        ap.status = $("#af_status").value || "scheduled";
        ap.note = ($("#af_note").value||"").trim();

        const idx = db.appointments.findIndex(x=>x.id===ap.id);
        if(idx>=0) db.appointments[idx] = ap;
        else db.appointments.unshift(ap);

        saveDB(db);
        db = loadDB();
        closeModal();
        renderAll();
        toast(isEdit?"ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„":"ØªÙ… Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ¹Ø¯", "ok");
      });
    }
  });
}

function renderAppointments(){
  const q = ($("#apptSearch").value||"").trim().toLowerCase();
  const from = $("#apptFrom").value || "";
  const to = $("#apptTo").value || "";
  const status = $("#apptStatusFilter").value || "";

  let list = db.appointments.slice();

  if(from){
    const f = new Date(from+"T00:00");
    list = list.filter(a => new Date(a.at) >= f);
  }
  if(to){
    const t = new Date(to+"T23:59");
    list = list.filter(a => new Date(a.at) <= t);
  }
  if(status){
    list = list.filter(a => a.status===status);
  }
  if(q){
    list = list.filter(a=>{
      const pName = patientName(a.patientId).toLowerCase();
      const hay = [pName, a.note, a.status].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  list.sort((a,b)=> new Date(a.at)-new Date(b.at));

  $("#apptsList").innerHTML = list.map(a=>{
    const p = patientById(a.patientId);
    const pill = apptPill(a.status);
    return `
      <div class="item">
        <div class="meta">
          <b>${fmtDate(a.at)} â€” ${fmtTime(a.at)}</b>
          <div class="sub">
            <span class="pill info">${escapeHtml(p?.name || "Ù…Ø±ÙŠØ¶ Ù…Ø­Ø°ÙˆÙ")}</span>
            <span>${pill}</span>
            <span class="muted2">${escapeHtml(a.note||"")}</span>
          </div>
        </div>
        <div class="ops">
          <button class="btn" data-appt-open="${a.id}">âœï¸ Ø¥Ø¯Ø§Ø±Ø©</button>
        </div>
      </div>
    `;
  }).join("");

  $("#apptsEmpty").classList.toggle("hidden", list.length>0);

  $$("[data-appt-open]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const id = b.getAttribute("data-appt-open");
      const ap = db.appointments.find(x=>x.id===id);
      if(ap) openApptForm(ap);
    });
  });
}

/* =========================
   DOMAIN: PAYMENTS
========================= */
function openPaymentForm(existingOrPrefill=null){
  const isEdit = existingOrPrefill && existingOrPrefill.id;
  const pay = isEdit ? {...existingOrPrefill} : {
    id: uid(),
    patientId: existingOrPrefill?.patientId || "",
    at: new Date().toISOString().slice(0,10),
    amount: 0,
    method: "cash",
    note: ""
  };

  const patientOptions = db.patients
    .slice()
    .sort((a,b)=> a.name.localeCompare(b.name, "ar"))
    .map(p=>`<option value="${p.id}" ${p.id===pay.patientId?"selected":""}>${escapeHtml(p.name)} â€” ${escapeHtml(p.phone||"")}</option>`)
    .join("");

  openModal({
    title: isEdit ? "ØªØ¹Ø¯ÙŠÙ„ Ø¯ÙØ¹Ø©" : "Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©",
    sub: "Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙŠØ¶ + Ù…Ø¨Ù„Øº + ØªØ§Ø±ÙŠØ® + Ø·Ø±ÙŠÙ‚Ø©",
    bodyHTML: `
      <div class="stack">
        <div>
          <label class="muted">Ø§Ù„Ù…Ø±ÙŠØ¶ *</label>
          <select id="pf_patient">
            <option value="">â€” Ø§Ø®ØªØ± Ù…Ø±ÙŠØ¶ â€”</option>
            ${patientOptions}
          </select>
        </div>

        <div class="row">
          <div>
            <label class="muted">Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ø£) *</label>
            <input id="pf_amount" inputmode="decimal" value="${escapeHtml(pay.amount)}" placeholder="Ù…Ø«Ø§Ù„: 20" />
          </div>
          <div>
            <label class="muted">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input id="pf_at" type="date" value="${escapeHtml(pay.at)}" />
          </div>
        </div>

        <div class="row">
          <div>
            <label class="muted">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
            <select id="pf_method">
              <option value="cash" ${pay.method==="cash"?"selected":""}>ÙƒØ§Ø´</option>
              <option value="visa" ${pay.method==="visa"?"selected":""}>Visa</option>
              <option value="bank" ${pay.method==="bank"?"selected":""}>ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
              <option value="other" ${pay.method==="other"?"selected":""}>Ø£Ø®Ø±Ù‰</option>
            </select>
          </div>
          <div>
            <label class="muted">Ù…Ù„Ø§Ø­Ø¸Ø©</label>
            <input id="pf_note" value="${escapeHtml(pay.note)}" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
          </div>
        </div>

        <div class="hint">
          Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ (Ù…Ø³ØªØ­Ù‚/Ø±ØµÙŠØ¯) ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† (Ø¬Ù„Ø³Ø§ØªÃ—Ø³Ø¹Ø±) Ù†Ø§Ù‚Øµ Ø§Ù„Ø¯ÙØ¹Ø§Øª.
        </div>
      </div>
    `,
    footHTML: `
      <button class="btn primary" id="pf_save2">${isEdit?"Ø­ÙØ¸":"Ø¥Ø¶Ø§ÙØ©"}</button>
      ${isEdit? `<button class="btn danger" id="pf_del2">Ø­Ø°Ù</button>` : ``}
      <button class="btn" id="pf_cancel2">Ø¥Ù„ØºØ§Ø¡</button>
    `,
    onOpen: ()=>{
      $("#pf_cancel2").addEventListener("click", closeModal);

      if(isEdit){
        $("#pf_del2").addEventListener("click", ()=>{
          confirmDanger("Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©ØŸ", "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.", ()=>{
            db.payments = db.payments.filter(x=>x.id!==pay.id);
            saveDB(db);
            db = loadDB();
            closeModal();
            renderAll();
            toast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©", "ok");
          });
        });
      }

      $("#pf_save2").addEventListener("click", ()=>{
        const pid = $("#pf_patient").value;
        const amount = Number(($("#pf_amount").value||"0").replace(",",".")) || 0;
        if(!pid){ toast("Ø§Ø®ØªØ± Ù…Ø±ÙŠØ¶", "warn"); return; }
        if(amount<=0){ toast("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­", "warn"); return; }

        pay.patientId = pid;
        pay.amount = amount;
        pay.at = $("#pf_at").value || todayISO();
        pay.method = $("#pf_method").value || "cash";
        pay.note = ($("#pf_note").value||"").trim();

        const idx = db.payments.findIndex(x=>x.id===pay.id);
        if(idx>=0) db.payments[idx] = pay;
        else db.payments.unshift(pay);

        saveDB(db);
        db = loadDB();
        closeModal();
        renderAll();
        toast(isEdit?"ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„":"ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©", "ok");
      });
    }
  });
}

function renderPayments(){
  const q = ($("#paySearch").value||"").trim().toLowerCase();
  let list = db.payments.slice();

  if(q){
    list = list.filter(x=>{
      const pName = patientName(x.patientId).toLowerCase();
      const hay = [pName, x.method, x.note].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  list.sort((a,b)=> new Date(b.at)-new Date(a.at));

  $("#paymentsList").innerHTML = list.map(x=>{
    const p = patientById(x.patientId);
    const method = x.method==="cash" ? "ÙƒØ§Ø´" :
                   x.method==="visa" ? "Visa" :
                   x.method==="bank" ? "ØªØ­ÙˆÙŠÙ„" : "Ø£Ø®Ø±Ù‰";
    return `
      <div class="item">
        <div class="meta">
          <b>${fmtMoney(x.amount)} â€” ${fmtDate(x.at)}</b>
          <div class="sub">
            <span class="pill info">${escapeHtml(p?.name || "Ù…Ø±ÙŠØ¶ Ù…Ø­Ø°ÙˆÙ")}</span>
            <span class="pill">${method}</span>
            <span class="muted2">${escapeHtml(x.note||"")}</span>
          </div>
        </div>
        <div class="ops">
          <button class="btn" data-pay-open="${x.id}">âœï¸ Ø¥Ø¯Ø§Ø±Ø©</button>
        </div>
      </div>
    `;
  }).join("");

  $("#paymentsEmpty").classList.toggle("hidden", list.length>0);

  $$("[data-pay-open]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const id = b.getAttribute("data-pay-open");
      const pay = db.payments.find(x=>x.id===id);
      if(pay) openPaymentForm(pay);
    });
  });
}

/* =========================
   DASHBOARD
========================= */
function renderDashboard(){
  // KPIs
  $("#kpiPatients").textContent = db.patients.length;

  const today = todayISO();
  const todayAppts = db.appointments.filter(a=> String(a.at).slice(0,10)===today && a.status!=="cancelled");
  $("#kpiTodayAppts").textContent = todayAppts.length;

  const mk = monthKey();
  const monthPayments = db.payments
    .filter(x=> String(x.at).slice(0,7)===mk)
    .reduce((a,b)=>a+Number(b.amount||0),0);
  $("#kpiMonthPayments").textContent = fmtMoney(monthPayments);

  // due = sum(billed - paid) across patients
  let dueSum = 0;
  for(const p of db.patients){
    const st = calcPatientStats(p.id);
    dueSum += st.due;
  }
  $("#kpiDue").textContent = fmtMoney(dueSum);

  // upcoming 7 days
  const now = new Date();
  const limit = new Date(now.getTime() + 7*24*60*60*1000);
  const upcoming = db.appointments
    .filter(a=>{
      const dt = new Date(a.at);
      return dt>=now && dt<=limit && a.status!=="cancelled";
    })
    .sort((a,b)=> new Date(a.at)-new Date(b.at))
    .slice(0, 8);

  $("#dashUpcoming").innerHTML = upcoming.map(a=>{
    const p = patientById(a.patientId);
    return `
      <div class="item">
        <div class="meta">
          <b>${fmtDate(a.at)} â€” ${fmtTime(a.at)}</b>
          <div class="sub">
            <span class="pill info">${escapeHtml(p?.name || "Ù…Ø±ÙŠØ¶ Ù…Ø­Ø°ÙˆÙ")}</span>
            ${apptPill(a.status)}
            <span class="muted2">${escapeHtml(a.note||"")}</span>
          </div>
        </div>
        <div class="ops">
          <button class="btn" data-appt-open="${a.id}">âœï¸</button>
        </div>
      </div>
    `;
  }).join("");
  $("#dashUpcomingEmpty").classList.toggle("hidden", upcoming.length>0);
  $("#nextCountPill").textContent = upcoming.length;

  $$("[data-appt-open]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const id = b.getAttribute("data-appt-open");
      const ap = db.appointments.find(x=>x.id===id);
      if(ap) openApptForm(ap);
    });
  });

  // alerts: due patients, today appointments, missing prices
  const alerts = [];

  const duePatients = db.patients
    .map(p=>({p, st: calcPatientStats(p.id)}))
    .filter(x=> x.st.due>0)
    .sort((a,b)=> b.st.due-a.st.due)
    .slice(0, 6);

  if(duePatients.length){
    for(const x of duePatients){
      alerts.push({
        title:`Ù…Ø³ØªØ­Ù‚ Ø¹Ù„Ù‰ ${x.p.name}`,
        desc:`Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${fmtMoney(x.st.due)} | Ø¬Ù„Ø³Ø§Øª: ${x.st.sessions} | Ø§Ù„Ø³Ø¹Ø±/Ø¬Ù„Ø³Ø©: ${fmtMoney(x.p.pricePerSession||0)}`,
        type:"warn",
        action: ()=> openPatientProfile(x.p.id)
      });
    }
  }

  const noPrice = db.patients.filter(p=> Number(p.pricePerSession||0)<=0 && Number(p.sessionsCount||0)>0).slice(0, 4);
  for(const p of noPrice){
    alerts.push({
      title:`Ø³Ø¹Ø± Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯`,
      desc:`${p.name} Ù„Ø¯ÙŠÙ‡ Ø¬Ù„Ø³Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„ÙƒÙ† Ø§Ù„Ø³Ø¹Ø±/Ø¬Ù„Ø³Ø© = 0`,
      type:"danger",
      action: ()=> openPatientProfile(p.id)
    });
  }

  if(todayAppts.length){
    alerts.unshift({
      title:`Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…`,
      desc:`Ø¹Ø¯Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ…: ${todayAppts.length}. Ø§ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.`,
      type:"info",
      action: ()=> switchTab("appointments")
    });
  }

  const viewAlerts = alerts.slice(0, 8);
  $("#dashAlerts").innerHTML = viewAlerts.map((a,i)=>`
    <div class="item">
      <div class="meta">
        <b>${escapeHtml(a.title)}</b>
        <div class="sub">
          <span class="pill ${a.type}">${a.type==="warn"?"ØªÙ†Ø¨ÙŠÙ‡":a.type==="danger"?"Ù…Ø´ÙƒÙ„Ø©":a.type==="info"?"Ù…Ø¹Ù„ÙˆÙ…Ø©":"â€”"}</span>
          <span class="muted2">${escapeHtml(a.desc)}</span>
        </div>
      </div>
      <div class="ops">
        <button class="btn" data-alert="${i}">ÙØªØ­</button>
      </div>
    </div>
  `).join("");
  $("#dashAlertsEmpty").classList.toggle("hidden", viewAlerts.length>0);

  $$("[data-alert]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const idx = Number(b.getAttribute("data-alert"));
      viewAlerts[idx]?.action?.();
    });
  });
}

/* =========================
   SETTINGS / BACKUP
========================= */
function updateStorageInfo(){
  const raw = localStorage.getItem(KEY) || "";
  const bytes = new Blob([raw]).size;
  const kb = (bytes/1024).toFixed(1);
  $("#storageInfo").textContent =
    `DB bytes: ${bytes} (${kb} KB)\n` +
    `patients: ${db.patients.length}\n` +
    `appointments: ${db.appointments.length}\n` +
    `payments: ${db.payments.length}\n` +
    `createdAt: ${db.meta?.createdAt || "â€”"}\n` +
    `version: ${db.meta?.version || "â€”"}`;
}

$("#exportBtn").addEventListener("click", ()=>{
  const payload = loadDB();
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `clinic_backup_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast("ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø©", "ok");
});

$("#importBtn").addEventListener("click", ()=> $("#importFile").click());
$("#importFile").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try{
    const txt = await f.text();
    const obj = JSON.parse(txt);
    if(!obj || !obj.patients || !obj.appointments || !obj.payments) throw new Error("Invalid schema");
    confirmDanger("Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ", "Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.", ()=>{
      localStorage.setItem(KEY, JSON.stringify(obj));
      db = loadDB();
      renderAll();
      toast("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯", "ok");
    });
  }catch(err){
    toast("Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­", "danger");
  }finally{
    e.target.value = "";
  }
});

$("#wipeDataBtn").addEventListener("click", ()=>{
  confirmDanger("Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©ØŸ", "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø±Ø¶Ù‰ ÙˆØ§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª ÙÙ‚Ø·.", ()=>{
    const keep = { meta:{...db.meta, wipedAt:new Date().toISOString()}, patients:[], appointments:[], payments:[] };
    localStorage.setItem(KEY, JSON.stringify(keep));
    db = loadDB();
    renderAll();
    toast("ØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©", "ok");
  });
});

$("#wipeAllBtn").addEventListener("click", ()=>{
  confirmDanger("Ù…Ø³Ø­ Ø´Ø§Ù…Ù„ØŸ", "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª + ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±. Ø³ØªØ¹ÙˆØ¯ Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„Ù‰.", ()=>{
    localStorage.removeItem(KEY);
    localStorage.removeItem(PASS_KEY);
    localStorage.removeItem(SESSION_KEY);
    db = loadDB();
    setSession(false);
    boot();
    toast("ØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Ù…Ù„", "ok");
  });
});

$("#changePassBtn").addEventListener("click", async ()=>{
  const np = ($("#newPass").value||"").trim();
  if(np.length<4){ toast("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø© (4 Ø£Ø­Ø±Ù+)", "warn"); return; }
  const h = await sha256(np);
  localStorage.setItem(PASS_KEY, h);
  $("#newPass").value = "";
  toast("ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", "ok");
});

/* =========================
   QUICK ACTIONS
========================= */
$("#quickAddPatient").addEventListener("click", ()=> openPatientForm(null));
$("#quickAddAppt").addEventListener("click", ()=> openApptForm(null));
$("#quickAddPayment").addEventListener("click", ()=> openPaymentForm(null));

$("#addPatientBtn").addEventListener("click", ()=> openPatientForm(null));
$("#addApptBtn").addEventListener("click", ()=> openApptForm(null));
$("#addPaymentBtn").addEventListener("click", ()=> openPaymentForm(null));

$("#patientSearch").addEventListener("input", renderPatients);
$("#apptSearch").addEventListener("input", renderAppointments);
$("#apptFrom").addEventListener("change", renderAppointments);
$("#apptTo").addEventListener("change", renderAppointments);
$("#apptStatusFilter").addEventListener("change", renderAppointments);
$("#clearApptFilters").addEventListener("click", ()=>{
  $("#apptSearch").value="";
  $("#apptFrom").value="";
  $("#apptTo").value="";
  $("#apptStatusFilter").value="";
  renderAppointments();
});
$("#paySearch").addEventListener("input", renderPayments);

/* =========================
   TOAST
========================= */
let toastEl = null;
function toast(msg, type="info"){
  if(!toastEl){
    toastEl = document.createElement("div");
    toastEl.style.position="fixed";
    toastEl.style.bottom="16px";
    toastEl.style.left="16px";
    toastEl.style.zIndex="999";
    toastEl.style.maxWidth="min(460px, 92vw)";
    document.body.appendChild(toastEl);
  }
  const t = document.createElement("div");
  t.className = "card";
  t.style.marginTop="8px";
  t.style.borderRadius="16px";
  t.style.overflow="hidden";
  t.style.borderColor = type==="ok" ? "rgba(69,212,131,.35)" :
                        type==="warn" ? "rgba(255,191,54,.35)" :
                        type==="danger" ? "rgba(255,77,109,.35)" :
                        "rgba(76,179,255,.35)";
  t.innerHTML = `
    <div class="body" style="display:flex; gap:10px; align-items:flex-start">
      <div class="pill ${type==="danger"?"danger":type==="warn"?"warn":type==="ok"?"ok":"info"}">${type==="ok"?"ØªÙ…":type==="warn"?"ØªÙ†Ø¨ÙŠÙ‡":type==="danger"?"Ø®Ø·Ø£":"Ù…Ø¹Ù„ÙˆÙ…Ø©"}</div>
      <div style="flex:1">
        <div style="font-weight:700">${escapeHtml(msg)}</div>
        <div class="muted" style="font-size:12px; margin-top:4px">${new Date().toLocaleTimeString("ar-JO",{hour:"2-digit", minute:"2-digit"})}</div>
      </div>
    </div>
  `;
  toastEl.appendChild(t);
  setTimeout(()=>{ t.style.opacity="0"; t.style.transform="translateY(6px)"; t.style.transition=".25s"; }, 2600);
  setTimeout(()=>{ t.remove(); }, 2900);
}

/* =========================
   CONFIRM DANGER
========================= */
function confirmDanger(title, sub, onYes){
  openModal({
    title,
    sub,
    bodyHTML: `
      <div class="hint">
        <b>ØªØ£ÙƒÙŠØ¯:</b> ${escapeHtml(sub)}
        <div class="hr"></div>
        <span class="muted2">Ù„Ù† ØªØ³ØªØ·ÙŠØ¹ Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°.</span>
      </div>
    `,
    footHTML: `
      <button class="btn danger" id="c_yes">Ù†Ø¹Ù…ØŒ Ù†ÙÙ‘Ø°</button>
      <button class="btn" id="c_no">Ø¥Ù„ØºØ§Ø¡</button>
    `,
    onOpen: ()=>{
      $("#c_no").addEventListener("click", closeModal);
      $("#c_yes").addEventListener("click", ()=>{
        closeModal();
        onYes?.();
      });
    }
  });
}

/* =========================
   SEED DATA
========================= */
$("#seedBtn").addEventListener("click", ()=>{
  // only if empty-ish
  if(db.patients.length || db.appointments.length || db.payments.length){
    toast("ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙØ¹Ù„ â€” Ù„Ù† Ø£Ø¶ÙŠÙ ØªØ¬Ø±ÙŠØ¨ÙŠ", "warn");
    return;
  }
  const p1 = {id:uid(), name:"Ø³Ø§Ø±Ø© Ø§Ù„Ø®Ø§Ù„Ø¯ÙŠ", phone:"0790000000", fileNo:"A-001", gender:"female", birthYear:"1998", address:"Ø¹Ù…Ù‘Ø§Ù†", notes:"Ù…ØªØ§Ø¨Ø¹Ø© Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©", pricePerSession:20, sessionsCount:3, followUps:[]};
  const p2 = {id:uid(), name:"Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹Ø¬Ø§Ø±Ù…Ø©", phone:"0781111111", fileNo:"A-002", gender:"male", birthYear:"1989", address:"Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡", notes:"Ø­Ø³Ø§Ø³ÙŠØ© Ø£Ø¯ÙˆÙŠØ©", pricePerSession:25, sessionsCount:5, followUps:[]};
  const p3 = {id:uid(), name:"Ù„ÙŠÙ† Ø£Ø¨Ùˆ Ø§Ù„Ø±Ø§ØºØ¨", phone:"0772222222", fileNo:"A-003", gender:"female", birthYear:"2001", address:"Ø¥Ø±Ø¨Ø¯", notes:"â€”", pricePerSession:15, sessionsCount:2, followUps:[]};
  db.patients.push(p1,p2,p3);

  const a1 = {id:uid(), patientId:p1.id, at:new Date(Date.now()+2*60*60*1000).toISOString().slice(0,16), status:"scheduled", note:"Ø¬Ù„Ø³Ø© Ù…ØªØ§Ø¨Ø¹Ø©"};
  const a2 = {id:uid(), patientId:p2.id, at:new Date(Date.now()+24*60*60*1000).toISOString().slice(0,16), status:"scheduled", note:"Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‚ÙŠÙŠÙ…"};
  const a3 = {id:uid(), patientId:p3.id, at:new Date(Date.now()-24*60*60*1000).toISOString().slice(0,16), status:"done", note:"ØªÙ…Øª Ø§Ù„Ø¬Ù„Ø³Ø©"};
  db.appointments.push(a1,a2,a3);

  const pay1 = {id:uid(), patientId:p2.id, at:todayISO(), amount:50, method:"cash", note:"Ø¯ÙØ¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø³Ø§Ø¨"};
  const pay2 = {id:uid(), patientId:p1.id, at:todayISO(), amount:20, method:"visa", note:"Ø¬Ù„Ø³Ø© Ø§Ù„ÙŠÙˆÙ…"};
  db.payments.push(pay1,pay2);

  p2.followUps.unshift({id:uid(), at:new Date().toISOString(), note:"ØªØ­Ø³Ù† ÙÙŠ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ØŒ Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¹Ø¯ Ø£Ø³Ø¨ÙˆØ¹"});
  p1.followUps.unshift({id:uid(), at:new Date().toISOString(), note:"Ø¬Ù„Ø³Ø© ØªÙ…Ø§Ø±ÙŠÙ† Ù…Ù†Ø²Ù„ÙŠØ© + Ø¥Ø±Ø´Ø§Ø¯Ø§Øª"});

  saveDB(db);
  db = loadDB();
  renderAll();
  toast("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©", "ok");
});

/* =========================
   RENDER ALL
========================= */
function renderAll(){
  rebuildBadges();
  setTodayPill();
  renderDashboard();
  renderPatients();
  renderAppointments();
  renderPayments();
  updateStorageInfo();
}

/* =========================
   LOGIN / AUTH
========================= */
function showLogin(){
  $("#appView").classList.add("hidden");
  $("#loginView").classList.remove("hidden");
}
function showApp(){
  $("#loginView").classList.add("hidden");
  $("#appView").classList.remove("hidden");
}

async function handleLogin(){
  const pass = ($("#passInput").value||"").trim();
  if(pass.length<4){
    loginMsg("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø© (4 Ø£Ø­Ø±Ù+)", "warn");
    return;
  }

  const h = await sha256(pass);

  if(!hasPass()){
    // set new password
    localStorage.setItem(PASS_KEY, h);
    setSession(true);
    $("#passInput").value="";
    loginMsg("ØªÙ… ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ âœ…", "ok");
    boot();
    return;
  }

  const saved = localStorage.getItem(PASS_KEY);
  if(saved === h){
    setSession(true);
    $("#passInput").value="";
    loginMsg("ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…", "ok");
    boot();
  }else{
    loginMsg("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©", "danger");
  }
}

function loginMsg(text, type="info"){
  const el = $("#loginMsg");
  el.classList.remove("hidden");
  el.innerHTML = `<span class="pill ${type==="danger"?"danger":type==="warn"?"warn":type==="ok"?"ok":"info"}">${type==="ok"?"ØªÙ…":type==="warn"?"ØªÙ†Ø¨ÙŠÙ‡":type==="danger"?"Ø®Ø·Ø£":"Ù…Ø¹Ù„ÙˆÙ…Ø©"}</span> <span style="margin-inline-start:8px">${escapeHtml(text)}</span>`;
}

$("#loginBtn").addEventListener("click", handleLogin);
$("#passInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") handleLogin(); });

$("#resetPassBtn").addEventListener("click", ()=>{
  confirmDanger("Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ", "Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ.", ()=>{
    localStorage.removeItem(PASS_KEY);
    setSession(false);
    $("#passInput").value="";
    loginMsg("ØªÙ… Ø­Ø°Ù ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±. Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©.", "warn");
  });
});

$("#logoutBtn").addEventListener("click", ()=>{
  setSession(false);
  toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬", "ok");
  boot();
});

/* =========================
   BOOT
========================= */
function boot(){
  db = loadDB();
  if(!isLoggedIn()){
    showLogin();
    $("#passInput").focus();
    return;
  }
  showApp();
  switchTab(currentTab || "dashboard");
  setStatus("Smart");
  renderAll();
}

// init
boot();
</script>
</body>
</html>
